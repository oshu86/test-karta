<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>index – Interaktiv karta (v3.6.0 – ikon fade-in & storlekskurva)</title>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
  :root{--bg:#0f1115;--ink:#e6e6e6;--muted:#2a3142;--panel:#141822;--shadow:rgba(0,0,0,.45);--accent:#ffd166;--vh:1vh;--marker-size:38px}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;overflow:hidden}
  #stage{position:relative;width:100vw;height:calc(var(--vh)*100);overflow:hidden;touch-action:none;-webkit-user-select:none;-webkit-touch-callout:none}
  #world{position:absolute;left:0;top:0;transform-origin:0 0;will-change:transform}
  #map{display:block;user-select:none;-webkit-user-drag:none;pointer-events:none;max-width:none}

  /* === Marker & konstant hitbox === */
  .marker{position:absolute;width:var(--marker-size);height:var(--marker-size);transform:translate(-50%,-100%);cursor:pointer;opacity:0;/* start: invis */}
  .marker.open{filter:drop-shadow(0 0 6px var(--accent))}
  .marker img{width:100%;height:100%;display:block;object-fit:contain;image-rendering:auto;backface-visibility:hidden;pointer-events:none}
  /* Pseudo-element som fungerar som träffyta för drag – håller konstant px-storlek oavsett zoom */
  .marker::before{content:"";position:absolute;left:50%;top:50%;width:56px;height:56px;border-radius:16px;transform:translate(-50%,-50%) scale(var(--hit-comp,1));pointer-events:auto;background:transparent}

  #sidebar{position:fixed;left:0;top:0;height:100dvh;width:360px;max-width:90vw;background:rgba(20,24,34,.96);border-right:1px solid var(--muted);box-shadow:0 6px 20px var(--shadow);z-index:30;display:none}
  #sidebar header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;border-bottom:1px solid #262c3b}
  #sidebar h3{margin:0;font-size:16px;font-weight:600;opacity:.9}
  .mini{border:1px solid var(--muted);background:#1a2030;color:#ddd;padding:6px 10px;border-radius:8px;cursor:pointer}
  #content{height:calc(100dvh - 140px);overflow:auto;padding:12px}
  #noteBody{background:#0e1220;border:1px solid #2a3142;border-radius:8px;padding:10px;min-height:180px;white-space:pre-wrap;outline:none;word-break:break-word;overflow-wrap:anywhere}
  #noteBody:focus{box-shadow:inset 0 0 0 2px #3b82f6}
  .note-img{max-width:100%;height:auto;display:block;margin:8px 0;border-radius:6px;border:1px solid #2a3142;cursor:zoom-in}

  #iconPicker{display:flex;gap:8px;align-items:center;padding:8px 12px;border-bottom:1px solid #262c3b;flex-wrap:wrap}
  .iconopt{width:28px;height:28px;border:1px solid #374151;border-radius:6px;background:#0e1220;background-size:contain;background-position:center;background-repeat:no-repeat;cursor:pointer;opacity:.85}
  .iconopt.active{outline:2px solid #60a5fa; opacity:1}
  #mIconPicker{display:flex;gap:10px;align-items:center;padding:8px 12px;flex-wrap:wrap}
  .miconopt{width:34px;height:34px;border:1px solid #374151;border-radius:8px;background:#0e1220;background-size:contain;background-position:center;background-repeat:no-repeat;cursor:pointer;opacity:.9}
  .miconopt.active{outline:2px solid #60a5fa; opacity:1}

  #lightbox{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;z-index:100;touch-action:none}
  #lightboxInner{position:relative;max-width:96vw;max-height:96vh;overflow:hidden}
  #lightboxImg{display:block;max-width:none;user-select:none;-webkit-user-drag:none;transform-origin:0 0;will-change:transform}
  #lightboxClose{position:fixed;right:14px;top:calc(env(safe-area-inset-top) + 10px);background:rgba(0,0,0,.55);color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:8px 10px;z-index:110;cursor:pointer}

  #overlay{position:absolute;left:0;top:0;overflow:visible;pointer-events:none}
  .measure-line{stroke:#35231c; stroke-width:5; fill:none; vector-effect:non-scaling-stroke; stroke-linecap:round; stroke-linejoin:round}
  .measure-label{font:14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;fill:#e6e6e6;paint-order:stroke;stroke:rgba(0,0,0,.6);stroke-width:3}

  #toolbox{position:fixed;right:8px;top:env(safe-area-inset-top,8px);display:flex;gap:8px;z-index:60;align-items:center;flex-wrap:wrap;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
  .toolbtn{background:#111827;color:#e5e7eb;border:1px solid #374151;padding:8px 10px;border-radius:10px;cursor:pointer;font-size:14px;white-space:nowrap}
  .toolbtn.active{outline:2px solid #60a5fa}

  #markerSizePanel{display:none}

  #scalebar{position:fixed;left:14px;bottom:calc(14px + env(safe-area-inset-bottom));z-index:70;color:#e5e7eb;font-size:12px}
  #scalebar .bar{height:6px;background:#e5e7eb;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.35) inset}
  #scalebar .label{margin-top:6px;text-align:center;opacity:.9}

  #sheet{position:fixed;left:0;right:0;bottom:0;z-index:90;display:none}
  #sheetPanel{margin:0 auto;max-width:880px;background:rgba(20,24,34,.98);border-top-left-radius:16px;border-top-right-radius:16px;border:1px solid #2a3142;box-shadow:0 -8px 24px rgba(0,0,0,.45);padding:6px 12px 14px;transform:translateY(0);will-change:transform;touch-action:none}
  #sheetHeader{display:flex;align-items:center;justify-content:space-between;gap:8px;padding-bottom:8px;border-bottom:1px solid #262c3b;position:relative;touch-action:none}
  #sheetHandle{width:48px;height:14px;display:flex;flex-direction:column;gap:3px;align-items:center;justify-content:center;margin:0 auto 8px;touch-action:none}
  #sheetHandle span{width:36px;height:3px;background:#3b4154;border-radius:2px;opacity:.95}
  #sheetBody{max-height:48dvh;overflow:auto;-webkit-overflow-scrolling:touch;white-space:pre-wrap;word-break:break-word;overflow-wrap:anywhere}
  .mini-ghost{background:transparent;border:1px solid #374151;color:#e5e7eb;padding:6px 10px;border-radius:10px;cursor:pointer}
  .note-text{max-width:51ch}
</style>
</head>
<body>
  <aside id="sidebar">
    <header>
      <h3 id="sidebarTitle">Notis</h3>
      <div id="editorBtns">
        <button id="addImg" class="mini" type="button" title="Lägg till bild">+ Bild</button>
        <input id="imgInput" type="file" accept="image/*" style="display:none" />
      </div>
    </header>
    <div id="iconPicker"></div>
    <div id="content">
      <div id="noteBody" class="note-text" contenteditable="true" spellcheck="true" lang="sv">Skriv din not här...</div>
      <p id="pasteHint" style="opacity:.75;font-size:12px;margin-top:8px">Tips: Klistra in (Ctrl/Cmd+V) eller dra‑och‑släpp en bild direkt i textfältet. Klicka på en bild för stor visning.</p>
    </div>
  </aside>

  <div id="sheet">
    <div id="sheetPanel">
      <div id="sheetHandle" title="Dra upp för full, ner för stäng"><span></span><span></span><span></span></div>
      <div id="sheetHeader">
        <h3 id="sheetTitle" style="margin:0;font-size:15px">Notis</h3>
        <div id="sheetBtns">
          <div id="mIconPicker"></div>
          <button id="mAddImg" class="mini-ghost" type="button" title="Lägg till bild">+ Bild</button>
          <button id="sheetClose" class="mini-ghost" type="button" title="Stäng">Stäng</button>
          <input id="mImgInput" type="file" accept="image/*" style="display:none" />
        </div>
      </div>
      <div id="sheetBody" class="note-text" contenteditable="true" spellcheck="true" lang="sv"></div>
      <p id="sheetHint" style="opacity:.75;font-size:12px;margin-top:8px">Tips: dra på de tre strecken för att expandera/stänga.</p>
    </div>
  </div>

  <div id="toolbox">
    <button id="btnModeNotes" class="toolbtn active" title="Skapa/hantera notiser">Läge: Notiser</button>
    <button id="btnModeMeasure" class="toolbtn" title="Mät avstånd">Mät</button>
    <button id="btnUndo" class="toolbtn" title="Ångra senaste mätpunkt">Ångra</button>
    <button id="btnReset" class="toolbtn" title="Ny mätning">Ny mätning</button>
    <button id="btnExport" class="toolbtn" title="Exportera ZIP (data.json + images + icons)">Export</button>
    <div id="markerSizePanel" aria-hidden="true"></div>
  </div>

  <div id="scalebar"><div class="bar" id="sbBar" style="width:120px"></div><div class="label" id="sbLabel">—</div></div>

  <div id="stage">
    <div id="world">
      <img id="map" src="Tyraal.webp" alt="Tyraal-karta" />
      <svg id="overlay"></svg>
    </div>
  </div>

  <div id="lightbox"><button id="lightboxClose" type="button">Stäng</button><div id="lightboxInner"><img id="lightboxImg" alt="" /></div></div>

<script>
(function(){
  // === Parametrar för synlighet & storlek ===
  // Ikoner är osynliga från helt ut-zoomat läge tills zoom når en brytpunkt.
  // Vi arbetar i "normaliserad zoom" z = scale / startScale.
  const Z_APPEAR_START = 12.30;  // under detta: 0% synligt
  const Z_APPEAR_END   = 15.00;  // över detta: 100% synligt

  // Skärmstorlek vid full synlighet. Olika på mobil vs desktop.
  const IS_MOBILE = matchMedia('(max-width:820px)').matches;
  const ICON_TARGET_PX = IS_MOBILE ? 42 : 42;
  const ICON_MAX_PX    = IS_MOBILE ? 88 : 88; // övre spärr så inget blir groteskt

  const WEBP_QUALITY=0.8, MAX_IMG_EDGE=2560;
  const setVH=()=>document.documentElement.style.setProperty('--vh',(visualViewport?visualViewport.height:window.innerHeight)*.01+'px'); setVH(); (visualViewport||window).addEventListener('resize',setVH);
  const IS_PLAYER=(location.hash==='#player')||(new URLSearchParams(location.search).get('mode')==='player');
  const METERS_PER_PIXEL=250000/1073.6; const MAP_WIDTH=8192, MAP_HEIGHT=5462; let metersPerPixelOverride=NaN; const getMetersPerPixel=()=>isNaN(metersPerPixelOverride)?METERS_PER_PIXEL:metersPerPixelOverride;

  const ICONS_NORMAL=['gods.png','kompass.png','person.png','sword.png','town.png'];
  const ICONS_OPEN  =['gods2.png','kompass2.png','person2.png','sword2.png','town2.png'];
  const ICON_COUNT=Math.min(ICONS_NORMAL.length, ICONS_OPEN.length);
  const ICONS_PATH = IS_PLAYER ? 'icons/' : '';
  function _2xName(name){ const i=name.lastIndexOf('.'); return i>0 ? name.slice(0,i)+'@2x'+name.slice(i) : name+'@2x'; }
  function withPath(name){ return ICONS_PATH + name; }

  let MARKER_BASE_PX = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--marker-size'))||38;

  const stage=$('#stage'), world=$('#world'), map=$('#map'), overlay=$('#overlay');
  const sidebar=$('#sidebar'), sidebarTitle=$('#sidebarTitle'), editorBtns=$('#editorBtns'), noteBody=$('#noteBody'), pasteHint=$('#pasteHint');
  const addImgBtn=$('#addImg'), imgInput=$('#imgInput'), mAddImgBtn=$('#mAddImg'), mImgInput=$('#mImgInput');
  const sheet=$('#sheet'), sheetPanel=$('#sheetPanel'), sheetBody=$('#sheetBody'), sheetTitle=$('#sheetTitle'), sheetClose=$('#sheetClose'), sheetHint=$('#sheetHint');
  const lightbox=$('#lightbox'), lightboxImg=$('#lightboxImg'), lightboxInner=$('#lightboxInner'), lightboxClose=$('#lightboxClose');
  const btnModeNotes=$('#btnModeNotes'), btnModeMeasure=$('#btnModeMeasure'), btnUndo=$('#btnUndo'), btnReset=$('#btnReset'), btnExport=$('#btnExport');
  const sbBar=$('#sbBar'), sbLabel=$('#sbLabel');
  const iconPicker=$('#iconPicker'), mIconPicker=$('#mIconPicker');
  function $(s){return document.querySelector(s)}

  let scale=1, MIN=1, MAX=24, startScale=1, tx=0, ty=0, imgW=0, imgH=0;
  const clamp=(v,a,b)=>Math.min(b,Math.max(a,v));
  function lerp(a,b,t){ return a+(b-a)*t; }

  function getPanBounds(){ const vw=stage.clientWidth, vh=stage.clientHeight, w=imgW*scale, h=imgH*scale, cx=(vw-w)/2, cy=(vh-h)/2; if(w<=vw&&h<=vh)return{minTx:cx,maxTx:cx,minTy:cy,maxTy:cy}; if(w<=vw)return{minTx:cx,maxTx:cx,minTy:Math.min(0,vh-h),maxTy:0}; if(h<=vh)return{minTx:Math.min(0,vw-w),maxTx:0,minTy:cy,maxTy:cy}; return{minTx:Math.min(0,vw-w),maxTx:0,minTy:Math.min(0,vh-h),maxTy:0}; }
  function clampPan(){ const b=getPanBounds(); tx=clamp(tx,b.minTx,b.maxTx); ty=clamp(ty,b.minTy,b.maxTy); }

  function visibilityT(){
    // normaliserad zoom
    const z = scale / startScale;
    const t = (z - Z_APPEAR_START) / (Z_APPEAR_END - Z_APPEAR_START);
    return clamp(t, 0, 1);
  }

  function cssScaleForMarker(desiredPx){
    // Håll exakt "desiredPx" på skärmen oavsett zoom
    const s = scale;
    const px = clamp(desiredPx, 0, ICON_MAX_PX);
    const safePx = Math.max(px, 0.0001); // undvik div/0 nära 0
    return safePx / (MARKER_BASE_PX * s);
  }

  function applyTransform(){
    world.style.transform=`translate(${tx}px,${ty}px) scale(${scale})`;
    const t = visibilityT();

    // Väx ikoner från 0 px → ICON_TARGET_PX när t går 0→1
    const targetPx = lerp(0, ICON_TARGET_PX, t);
    const cssS = cssScaleForMarker(targetPx);
    const hitComp = targetPx>0 ? 1/(scale * cssS) : 1; // konstant hitbox i px när synlig

    world.querySelectorAll('.marker').forEach(el=>{
      const extra=parseFloat(el.dataset.iconScale||'1');
      el.style.transform=`translate(-50%,-100%) scale(${cssS * extra})`;
      el.style.setProperty('--hit-comp', hitComp);
      el.style.opacity = t; // fade-in
      // Stäng av interaktion när nästan osynlig
      el.style.pointerEvents = (t>0.2)?'auto':'none';
      // För säkerhets skull: dölj helt under start
      el.style.visibility = (t>0 ? 'visible' : 'hidden');
    });

    overlay.setAttribute('width',imgW); overlay.setAttribute('height',imgH);
    if(typeof updateScaleBar==='function') updateScaleBar();
  }

  function zoomAt(sx,sy,f){ const r=stage.getBoundingClientRect(), x=sx-r.left, y=sy-r.top, wx=(x-tx)/scale, wy=(y-ty)/scale, ns=clamp(scale*f,MIN,MAX); tx=x-wx*ns; ty=y-wy*ns; scale=ns; clampPan(); applyTransform(); }
  function fitToScreenAndCenter(){ const vw=stage.clientWidth, vh=stage.clientHeight, w0=map.naturalWidth||MAP_WIDTH, h0=map.naturalHeight||MAP_HEIGHT; imgW=w0; imgH=h0; const s=Math.min(vw/imgW,vh/imgH); startScale=s; scale=s; MIN=startScale*.98; const w=imgW*scale, h=imgH*scale; tx=(vw-w)/2; ty=(vh-h)/2; applyTransform(); }
  stage.addEventListener('wheel',e=>{e.preventDefault(); zoomAt(e.clientX,e.clientY, e.deltaY<0?1.15:1/1.15)},{passive:false});
  const pointers=new Map(); let lastDist=null, leftPan=false, rightPan=false, panStart=null;
  stage.addEventListener('pointerdown',e=>{const onMarker=!!e.target.closest('.marker'); if(e.pointerType==='mouse'&&e.button===2){ rightPan=true; panStart={x:e.clientX,y:e.clientY,tx,ty}; window.addEventListener('contextmenu',ev=>ev.preventDefault(),{once:true}); stage.setPointerCapture(e.pointerId);} if(e.pointerType==='mouse'&&e.button===0&&!onMarker){ leftPan=true; panStart={x:e.clientX,y:e.clientY,tx,ty}; stage.setPointerCapture(e.pointerId);} if(e.pointerType!=='mouse'){ pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}); stage.setPointerCapture(e.pointerId);} });
  stage.addEventListener('pointermove',e=>{ if(e.pointerType!=='mouse'&&pointers.has(e.pointerId)){ pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}); const pts=[...pointers.values()]; if(pts.length===1&&!leftPan&&!rightPan){ const p=pts[0]; if(!panStart) panStart={x:e.clientX,y:e.clientY,tx,ty}; tx=panStart.tx+(p.x-panStart.x); ty=panStart.ty+(p.y-panStart.y); clampPan(); applyTransform(); return; } if(pts.length===2){ const [a,b]=pts, midX=(a.x+b.x)/2, midY=(a.y+b.y)/2, dist=Math.hypot(b.x-a.x,b.y-a.y); if(lastDist==null){lastDist=dist; return;} const f=dist/lastDist; lastDist=dist; zoomAt(midX,midY,f); return; } }
    if((leftPan||rightPan)&&panStart){ const p={x:e.clientX,y:e.clientY}; tx=panStart.tx+(p.x-panStart.x); ty=panStart.ty+(p.y-panStart.y); clampPan(); applyTransform(); }
  });
  function endPointer(e){ if(e.pointerType!=='mouse'){ pointers.delete(e.pointerId); if(pointers.size<2) lastDist=null; if(pointers.size===0) panStart=null; } if(e.pointerType==='mouse'){ if(leftPan||rightPan) stage.releasePointerCapture?.(e.pointerId); leftPan=false; rightPan=false; panStart=null; } }
  stage.addEventListener('pointerup',endPointer); stage.addEventListener('pointercancel',endPointer);

  const LSK='tyraal_markers_meta_v29', DB_NAME='tyraal_db', DB_STORE='notes'; let db=null; function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,1); r.onupgradeneeded=()=>{db=r.result; if(!db.objectStoreNames.contains(DB_STORE)) db.createObjectStore(DB_STORE,{keyPath:'id'})}; r.onsuccess=()=>{db=r.result; res(db)}; r.onerror=()=>rej(r.error)});} function idbGet(id){return new Promise((res,rej)=>{const tx=db.transaction(DB_STORE,'readonly'), st=tx.objectStore(DB_STORE), q=st.get(id); q.onsuccess=()=>res(q.result?.html||''); q.onerror=()=>rej(q.error)});} function idbSet(id,html){return new Promise((res,rej)=>{const tx=db.transaction(DB_STORE,'readwrite'), st=tx.objectStore(DB_STORE), q=st.put({id,html}); q.onsuccess=()=>res(); q.onerror=()=>rej(q.error)});} function idbBulkGet(ids){return Promise.all(ids.map(id=>idbGet(id).then(html=>({id,html}))));}
  function saveMeta(){ if(IS_PLAYER) return; const out=[...world.querySelectorAll('.marker')].map(m=>({ id:m.dataset.id, x:parseFloat(m.style.left), y:parseFloat(m.style.top), icon: parseInt(m.dataset.icon||'0',10)||0 })); try{localStorage.setItem(LSK,JSON.stringify(out))}catch(_){}}
  async function saveHTML(id,html){ if(IS_PLAYER) return; try{await idbSet(id,html)}catch(_){}}
  async function loadAllFromLocal(){ const meta=JSON.parse(localStorage.getItem(LSK)||'[]'); meta.forEach(o=>createMarker(o.x,o.y,o.id,false, o.icon||0)); const htmls=await idbBulkGet(meta.map(m=>m.id)); htmls.forEach(({id,html})=>{store[id]={html:html||''}}); }
  async function loadAllFromJSON(){ try{ const r=await fetch('data.json',{cache:'no-store'}); if(!r.ok) throw new Error('Kunde inte läsa data.json'); const data=await r.json(); if(typeof data.metersPerPixel==='number'&&isFinite(data.metersPerPixel)) metersPerPixelOverride=data.metersPerPixel; if(Array.isArray(data.markers)){ data.markers.forEach(m=>{ createMarker(m.x,m.y,m.id,false, m.icon||0); store[m.id]={html:m.html||''}; }); } } catch(err){ console.error(err); alert('Kunde inte ladda spelardata (data.json).'); } }

  const store={}; let openId=null; let inserting=false, handlersBound=false; function fileToDataURL(f){return new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f);});}
  async function insertImagesFromFiles(target, files){ if(inserting) return; inserting=true; try{ for(const f of files){ if(!f||!f.type||!f.type.startsWith('image/')) continue; const data=await fileToDataURL(f); const img=document.createElement('img'); img.className='note-img'; img.src=data; attachImageClick(img); target.appendChild(img);} if(openId){ const html=(IS_MOBILE?sheetBody.innerHTML:noteBody.innerHTML); store[openId]={html}; await saveHTML(openId,html); saveMeta(); } } finally{ inserting=false; } }
  function attachImageClick(img){ img.addEventListener('click',e=>{e.stopPropagation(); openLightbox(img.src);}); }

  function bindOnce(){ if(handlersBound) return; handlersBound=true; if(!IS_PLAYER){ addImgBtn?.addEventListener('click',()=>{imgInput.value=''; imgInput.click();}); imgInput?.addEventListener('change',async e=>{const fs=e.target.files; if(fs?.length) await insertImagesFromFiles(noteBody,fs); imgInput.value='';}); mAddImgBtn?.addEventListener('click',()=>{mImgInput.value=''; mImgInput.click();}); mImgInput?.addEventListener('change',async e=>{const fs=e.target.files; if(fs?.length) await insertImagesFromFiles(sheetBody,fs); mImgInput.value='';}); const pasteH=async (e,target)=>{const items=e.clipboardData?.items||[]; const files=[]; for(const it of items){ if(it.kind==='file'&&it.type.startsWith('image/')) files.push(it.getAsFile()); } if(files.length){ e.preventDefault(); e.stopPropagation(); if(!inserting) await insertImagesFromFiles(target,files); }}; noteBody?.addEventListener('paste',e=>pasteH(e,noteBody)); sheetBody?.addEventListener('paste',e=>pasteH(e,sheetBody)); const inputH=async target=>{ if(openId){ const html=target.innerHTML; store[openId]={html}; await saveHTML(openId,html); saveMeta(); } }; noteBody?.addEventListener('input',()=>inputH(noteBody)); sheetBody?.addEventListener('input',()=>inputH(sheetBody)); }
  }

  // Lightbox
  let lbOpen=false, lbScale=1, lbTx=0, lbTy=0, lbImgW=0, lbImgH=0, lbStart=null, lbLastDist=null; const LB_MIN=1, LB_MAX=8;
  function openLightbox(src){ lightboxImg.onload=()=>{ const box=lightboxInner.getBoundingClientRect(); lbImgW=lightboxImg.naturalWidth; lbImgH=lightboxImg.naturalHeight; const s=Math.min(box.width/lbImgW, box.height/lbImgH); lbScale=s; lbTx=(box.width-lbImgW*s)/2; lbTy=(box.height-lbImgH*s)/2; applyLightboxTransform(); }; lightboxImg.src=src; lightbox.style.display='flex'; lbOpen=true; lbStart=null; lbLastDist=null; }
  function closeLightbox(){ lbOpen=false; lightbox.style.display='none'; lightboxImg.src=''; }
  lightbox.addEventListener('click',e=>{ if(e.target===lightbox) closeLightbox(); }); lightboxClose.addEventListener('click',closeLightbox);
  function applyLightboxTransform(){ lightboxImg.style.transform=`translate(${lbTx}px,${lbTy}px) scale(${lbScale})`; }
  function lbClampPan(){ const box=lightboxInner.getBoundingClientRect(), w=lbImgW*lbScale, h=lbImgH*lbScale; const minX=Math.min(0,box.width-w), maxX=Math.max(0,box.width-w), minY=Math.min(0,box.height-h), maxY=Math.max(0,box.height-h); lbTx=clamp(lbTx,minX,maxX); lbTy=clamp(lbTy,minY,maxY); }
  function lbZoomAt(cx,cy,f){ const box=lightboxInner.getBoundingClientRect(), x=cx-box.left, y=cy-box.top, wx=(x-lbTx)/lbScale, wy=(y-lbTy)/lbScale, ns=clamp(lbScale*f,LB_MIN,LB_MAX); lbTx=x-wx*ns; lbTy=y-wy*ns; lbScale=ns; lbClampPan(); applyLightboxTransform(); }
  ;['pointerdown','pointermove','pointerup','pointercancel','wheel','dblclick'].forEach(evt=>{ lightbox.addEventListener(evt,e=>{e.stopPropagation(); if(evt!=='pointerup'&&evt!=='pointercancel') e.preventDefault();},{passive:false})});
  const lbPtrs=new Map(); lightbox.addEventListener('pointerdown',e=>{ if(!lbOpen) return; lightbox.setPointerCapture(e.pointerId); lbPtrs.set(e.pointerId,{x:e.clientX,y:e.clientY}); if(!lbStart) lbStart={x:e.clientX,y:e.clientY,tx:lbTx,ty:lbTy}; });
  lightbox.addEventListener('pointermove',e=>{ if(!lbOpen||!lbPtrs.has(e.pointerId)) return; lbPtrs.set(e.pointerId,{x:e.clientX,y:e.clientY}); const pts=[...lbPtrs.values()]; if(pts.length===1){ const p=pts[0]; if(!lbStart) lbStart={x:e.clientX,y:e.clientY,tx:lbTx,ty:lbTy}; lbTx=lbStart.tx+(p.x-lbStart.x); lbTy=lbStart.ty+(p.y-lbStart.y); lbClampPan(); applyLightboxTransform(); } else if(pts.length===2){ const [a,b]=pts, midX=(a.x+b.x)/2, midY=(a.y+b.y)/2, dist=Math.hypot(b.x-a.x,b.y-a.y); if(lbLastDist==null){lbLastDist=dist; return;} const f=dist/lbLastDist; lbLastDist=dist; lbZoomAt(midX,midY,f); } });
  function lbEnd(e){ lbPtrs.delete(e.pointerId); if(lbPtrs.size<2) lbLastDist=null; if(lbPtrs.size===0) lbStart=null; }
  lightbox.addEventListener('pointerup',lbEnd); lightbox.addEventListener('pointercancel',lbEnd); lightbox.addEventListener('wheel',e=>{ if(!lbOpen) return; lbZoomAt(e.clientX,e.clientY, e.deltaY<0?1.12:1/1.12); }); lightbox.addEventListener('dblclick',e=>{ if(!lbOpen) return; lbZoomAt(e.clientX,e.clientY,1.4); });

  function uid(){return Math.random().toString(36).slice(2,9)}
  function clientToWorldXY(x,y){ const r=stage.getBoundingClientRect(); const cx=x-r.left, cy=y-r.top; return {wx:(cx-tx)/scale, wy:(cy-ty)/scale}; }

  stage.addEventListener('dblclick',e=>{ if(mode!=='notes'||IS_PLAYER) return; if(e.target.closest('.marker')||e.target.closest('#sidebar')||e.target.closest('#sheet')) return; e.preventDefault(); const {wx,wy}=clientToWorldXY(e.clientX,e.clientY); const id=uid(); store[id]={html:'Skriv din not här...'}; createMarker(wx,wy,id,true,currentIconIndex); openMarker(id); },{passive:false});

  // Retina: sätt alltid srcset (iOS tar @2x automatiskt om det finns)
  async function markerSetIcon(el,index){
    el.dataset.icon=String(index||0);
    const isOpen=el.classList.contains('open');
    const baseArr = isOpen? ICONS_OPEN : ICONS_NORMAL;
    const base = baseArr[(Number.isInteger(index)&&index>=0&&index<baseArr.length)?index:0];
    const x1 = withPath(base); const x2 = withPath(_2xName(base));
    const img=el.querySelector('img')||el.appendChild(document.createElement('img'));
    img.decoding='async'; img.loading='eager';
    img.src = x1;            // 1x
    img.srcset = `${x1} 1x, ${x2} 2x`;
  }

  function createMarker(wx,wy,id,saveNow=true,iconIndex=0){ if(!isFinite(wx)||!isFinite(wy)) return null; const m=document.createElement('div'); m.className='marker'; m.dataset.id=id; m.style.left=wx+'px'; m.style.top=wy+'px';
    const img=document.createElement('img'); m.appendChild(img);
    markerSetIcon(m,iconIndex);
    let dragging=false, canDrag=false, startX=0, startY=0; const TH=4; let suppressNextClick=false;
    m.addEventListener('click',ev=>{ if(suppressNextClick){suppressNextClick=false;return;} ev.stopPropagation(); if(openId===id) closePanels(); else openMarker(id); });
    m.addEventListener('pointerdown',ev=>{ if(mode!=='notes'||IS_PLAYER) return; if(ev.pointerType==='mouse'&&ev.button!==0) return; canDrag=ev.altKey||ev.shiftKey; dragging=false; startX=ev.clientX; startY=ev.clientY; if(canDrag){ document.body.classList.add('grabbing'); stage.classList.add('grabbing'); m.setPointerCapture?.(ev.pointerId);} ev.stopPropagation(); });
    m.addEventListener('pointermove',ev=>{ if(!canDrag) return; const dx=ev.clientX-startX, dy=ev.clientY-startY; if(!dragging&&(Math.abs(dx)>TH||Math.abs(dy)>TH)) dragging=true; if(dragging){ const {wx,wy}=clientToWorldXY(ev.clientX,ev.clientY); m.style.left=wx+'px'; m.style.top=wy+'px'; } });
    m.addEventListener('pointerup',ev=>{ if(dragging){suppressNextClick=true; saveMeta();} dragging=false; canDrag=false; document.body.classList.remove('grabbing'); stage.classList.remove('grabbing'); });
    m.addEventListener('contextmenu',async ev=>{ if(IS_PLAYER) return; ev.preventDefault(); if(confirm('Ta bort denna markering och dess notis?')){ if(openId===id) closePanels(); world.removeChild(m); delete store[id]; saveMeta(); try{await idbSet(id,'')}catch(_){}} });
    world.appendChild(m); if(saveNow) saveMeta(); return m; }

  let currentIconIndex=0; function buildIconPicker(container,small=true){ if(IS_PLAYER){ container.style.display='none'; container.innerHTML=''; return; } container.innerHTML=''; for(let i=0;i<ICON_COUNT;i++){ const b=document.createElement('button'); b.type='button'; b.className= small?'iconopt':'miconopt'; b.style.backgroundImage=`url('${withPath(ICONS_NORMAL[i])}')`; b.title=`Ikon ${i+1}`; if(i===currentIconIndex) b.addEventListener('focus',()=>{}); if(i===currentIconIndex) b.classList.add('active'); b.addEventListener('click',()=>{ if(IS_PLAYER) return; currentIconIndex=i; [...container.parentElement.querySelectorAll('.iconopt, .miconopt')].forEach(x=>x.classList.remove('active')); b.classList.add('active'); if(openId){ const el=world.querySelector(`.marker[data-id="${openId}"]`); markerSetIcon(el,i); saveMeta(); } }); container.appendChild(b); } }

  function openMarker(id){ if(openId&&openId!==id){ const prev=world.querySelector(`.marker[data-id="${openId}"]`); if(prev){ prev.classList.remove('open'); markerSetIcon(prev, parseInt(prev.dataset.icon||'0',10)); } }
    openId=id; const marker=world.querySelector(`.marker[data-id="${id}"]`); if(marker){ marker.classList.add('open'); markerSetIcon(marker, parseInt(marker.dataset.icon||'0',10)); currentIconIndex=parseInt(marker.dataset.icon||'0',10)||0; }
    const html=store[id]?.html; const render=h=>{ if(IS_MOBILE){ sheetTitle.textContent='Notis'; sheet.style.display='block'; sheetBody.innerHTML=h; sheetBody.contentEditable=IS_PLAYER?'false':'true'; sheetHint.style.display=IS_PLAYER?'none':'block'; openSheet('half'); buildIconPicker(mIconPicker,false); } else { sidebarTitle.textContent='Notis'; sidebar.style.display='block'; noteBody.innerHTML=h; noteBody.contentEditable=IS_PLAYER?'false':'true'; pasteHint.style.display=IS_PLAYER?'none':'block'; buildIconPicker(iconPicker,true); } (IS_MOBILE?sheetBody:noteBody).querySelectorAll('img').forEach(img=>attachImageClick(img)); bindOnce(); if(editorBtns) editorBtns.style.display=IS_PLAYER?'none':'flex'; };
    if(typeof html!=='string'){ idbGet(id).then(h=>{store[id]={html:h||'Skriv din not här...'}; render(store[id].html);}); } else render(html||'Skriv din not här...'); }

  function closePanels(){ sidebar.style.display='none'; sheet.style.display='none'; const prev=openId?world.querySelector(`.marker[data-id="${openId}"]`):null; if(prev){ prev.classList.remove('open'); markerSetIcon(prev, parseInt(prev.dataset.icon||'0',10)); } openId=null; }
  stage.addEventListener('click',e=>{ if(mode!=='notes') return; if(e.target.closest('.marker')) return; closePanels(); });

  // Rullgardin
  let mode='notes', sheetState='half', sheetOffsetY=0; function sizes(){ const vh=(visualViewport?visualViewport.height:window.innerHeight); return {half:Math.round(vh*.50), full:Math.round(vh*.97), header:74}; }
  function closedOffset(){ const S=sizes(); return S.half+40; }
  function applySheetTransformOffset(o){ sheetOffsetY=o; sheetPanel.style.transform=`translateY(${Math.max(0,o)}px)`; }
  function setSheetHeight(state,anim=true){ sheetState=state; const S=sizes(); const h = state==='full'?S.full:(state==='half'?S.half:0); sheetBody.style.maxHeight=(state==='full'?(S.full-S.header):(state==='half'?(S.half-S.header):0))+'px'; if(anim) sheetPanel.style.transition='transform 160ms cubic-bezier(.2,.8,.2,1)'; applySheetTransformOffset(state==='closed'?closedOffset():0); if(state==='closed'){ sheet.style.display='none'; } else { sheet.style.display='block'; } if(anim) setTimeout(()=>{sheetPanel.style.transition='none'},170); }
  function openSheet(state='half'){ sheet.style.display='block'; setSheetHeight(state); }
  let dragStartY=0, dragStartTime=0, draggingSheet=false, baseOffset=0, lastY=0, lastT=0, velocityY=0; function sheetDragStart(e){ draggingSheet=true; dragStartY=e.clientY; lastY=e.clientY; lastT=performance.now(); dragStartTime=lastT; baseOffset=sheetOffsetY; try{e.currentTarget.setPointerCapture(e.pointerId);}catch(_){ } e.preventDefault(); }
  function sheetDragMove(e){ if(!draggingSheet) return; const now=performance.now(); const dy = e.clientY - dragStartY; const newOffset = clamp(baseOffset + Math.max(0, dy), 0, closedOffset()); applySheetTransformOffset(newOffset); const dt = Math.max(1, now - lastT); velocityY = (e.clientY - lastY) / dt; lastY=e.clientY; lastT=now; e.preventDefault(); }
  function sheetDragEnd(e){ if(!draggingSheet) return; draggingSheet=false; const totalDy = e.clientY - dragStartY; const time = Math.max(1, performance.now()-dragStartTime); const speed = (totalDy)/time; const fastFling = speed>0.8 || velocityY>0.8; const upSwipe = totalDy<-40; if(upSwipe){ setSheetHeight('full'); return; } const threshold = closedOffset()*0.45; if(fastFling || sheetOffsetY>threshold){ setSheetHeight('closed'); } else { setSheetHeight(sheetState==='closed'?'half':sheetState); } }
  ;[document.querySelector('#sheetHandle'),document.querySelector('#sheetHeader')].forEach(el=>{ el.addEventListener('pointerdown',sheetDragStart,{passive:false}); el.addEventListener('pointermove',sheetDragMove,{passive:false}); el.addEventListener('pointerup',sheetDragEnd); el.addEventListener('pointercancel',sheetDragEnd); });
  sheetClose.addEventListener('click',()=>setSheetHeight('closed'));

  // Mätning (oförändrad)
  let measurePoints=[], measurePath=null, measureLabel=null;
  function setMode(m){ mode=m; btnModeNotes.classList.toggle('active',m==='notes'); btnModeMeasure.classList.toggle('active',m==='measure'); if(m==='measure') closePanels(); if(m==='notes') clearMeasurePreview(); }
  btnModeNotes.addEventListener('click',()=>setMode('notes'));
  btnModeMeasure.addEventListener('click',()=>setMode('measure'));
  btnUndo.addEventListener('click',()=>{ if(mode!=='measure') setMode('measure'); measurePoints.pop(); updateMeasurePath(); });
  btnReset.addEventListener('click',()=>{ if(mode!=='measure') setMode('measure'); measurePoints=[]; updateMeasurePath(); });
  function clearMeasurePreview(){ if(measureLabel){measureLabel.remove(); measureLabel=null;} if(measurePath){measurePath.remove(); measurePath=null;} }
  function totalPixels(){ let tot=0; for(let i=1;i<measurePoints.length;i++){ const a=measurePoints[i-1], b=measurePoints[i]; tot+=Math.hypot(b.x-a.x,b.y-a.y);} return tot; }
  function updateMeasurePath(){ if(!measurePoints.length){ clearMeasurePreview(); return;} const d=measurePoints.map((p,i)=>(i?'L':'M')+p.x+' '+p.y).join(' '); if(!measurePath){ measurePath=document.createElementNS('http://www.w3.org/2000/svg','path'); measurePath.setAttribute('class','measure-line'); overlay.appendChild(measurePath);} measurePath.setAttribute('d',d); const lenPx=totalPixels(), lenMeters=lenPx*getMetersPerPixel(); let target=lenPx/2, acc=0, mid={x:measurePoints[0].x,y:measurePoints[0].y}; for(let i=1;i<measurePoints.length;i++){ const a=measurePoints[i-1], b=measurePoints[i], seg=Math.hypot(b.x-a.x,b.y-a.y); if(acc+seg>=target){ const t=(target-acc)/seg; mid={x:a.x+(b.x-a.x)*t, y:a.y+(b.y-a.y)*t}; break;} acc+=seg; } if(!measureLabel){ measureLabel=document.createElementNS('http://www.w3.org/2000/svg','text'); measureLabel.setAttribute('class','measure-label'); overlay.appendChild(measureLabel);} measureLabel.setAttribute('x',mid.x); measureLabel.setAttribute('y',mid.y-10); const km=lenMeters/1000, days=Math.max(1, Math.round(km/40)); const daysText=(days===1)?'1 dags resa':`${days} dagars resa`; measureLabel.textContent=(lenMeters>=1000)?`${km.toFixed(2)} km ≈ ${daysText}`:`${Math.round(lenMeters)} m`; }
  stage.addEventListener('click',e=>{ if(mode!=='measure') return; const r=stage.getBoundingClientRect(); const wx=(e.clientX-r.left-tx)/scale, wy=(e.clientY-r.top-ty)/scale; measurePoints.push({x:wx,y:wy}); updateMeasurePath(); });

  // Export (icons/ + @2x)
  async function fetchBlob(url){ const r=await fetch(url); if(!r.ok) throw new Error('404 '+url); return await r.blob(); }
  async function blobToImage(blob){ return await new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=URL.createObjectURL(blob); }); }
  async function make2xBlob(blob1x, mimeHint){ const img = await blobToImage(blob1x); const c=document.createElement('canvas'); const w=(img.naturalWidth||img.width||32)*2; const h=(img.naturalHeight||img.height||32)*2; c.width=w; c.height=h; const cx=c.getContext('2d'); cx.imageSmoothingEnabled=true; cx.imageSmoothingQuality='high'; cx.drawImage(img,0,0,w,h); const mime = (mimeHint && /^image\//.test(mimeHint)) ? mimeHint : 'image/png'; return await new Promise(res=>c.toBlob(b=>res(b), mime, 0.92)); }
  async function writeIconsFolderToZip(zip){ const folder = zip.folder('icons'); const uniq = new Set([].concat(ICONS_NORMAL, ICONS_OPEN)); for(const name of uniq){ const src1 = withPath(name).replace(/^icons\//,''); let blob1x=null, mime1x='image/png'; try{ blob1x = await fetchBlob(src1); mime1x = blob1x.type||mime1x; }catch{ console.warn('Ikon saknas (1x):', src1); continue; } folder.file(name, blob1x); const name2x = _2xName(name); const src2 = withPath(name2x).replace(/^icons\//,''); try{ const blob2x = await fetchBlob(src2); folder.file(name2x, blob2x); }catch{ try{ const gen2x = await make2xBlob(blob1x, mime1x); if(gen2x) folder.file(name2x, gen2x); }catch(err){ console.warn('Kunde inte generera @2x för', name, err); } } } }

  async function exportZip(){ try{ await openDB(); const meta=JSON.parse(localStorage.getItem(LSK)||'[]'); const htmls=await idbBulkGet(meta.map(m=>m.id)); const htmlById={}; htmls.forEach(({id,html})=>htmlById[id]=html||''); const zip=new JSZip(); const imagesFolder=zip.folder('images'); const seen=new Set(); const outMarkers=[]; for(const m of meta){ const processedHTML=await processNoteHTML(htmlById[m.id]||'', imagesFolder, seen); outMarkers.push({id:m.id,x:m.x,y:m.y,icon:m.icon||0,html:processedHTML}); } const payload={exportedAt:new Date().toISOString(), metersPerPixel:getMetersPerPixel(), markers:outMarkers}; zip.file('data.json', JSON.stringify(payload, null, 2)); await writeIconsFolderToZip(zip); const blob=await zip.generateAsync({type:'blob'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='export.zip'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href); } catch(err){ console.error(err); alert('Export misslyckades: '+err.message); } }
  btnExport.addEventListener('click',()=>{ if(IS_PLAYER) return; exportZip(); });

  async function init(){ imgW=map.naturalWidth; imgH=map.naturalHeight; if(IS_PLAYER){ btnExport.style.display='none'; pasteHint?.style?.setProperty('display','none'); editorBtns?.style?.setProperty('display','none'); sheetHint?.style?.setProperty('display','none'); iconPicker.style.display='none'; mIconPicker.style.display='none'; noteBody?.setAttribute('contenteditable','false'); sheetBody?.setAttribute('contenteditable','false'); await loadAllFromJSON(); } else { await openDB(); await loadAllFromLocal(); }
    fitToScreenAndCenter(); clampPan(); applyTransform(); if(!IS_PLAYER){ buildIconPicker(iconPicker,true); buildIconPicker(mIconPicker,false); } bindOnce(); if(typeof updateScaleBar==='function') updateScaleBar(); }
  if(map.complete&&map.naturalWidth) init(); else map.onload=init; window.addEventListener('resize',()=>{clampPan(); applyTransform(); if(typeof updateScaleBar==='function') updateScaleBar();});

  // Hjälp för not-bilder i export
  function dataURLtoImage(dataURL){return new Promise((res,rej)=>{const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.decoding='async'; img.src=dataURL;});}
  function canvasToBlob(canvas,mime,quality){return new Promise(res=>{ if(canvas.toBlob){ canvas.toBlob(b=>res(b),mime,quality);} else { const data=canvas.toDataURL(mime,quality), bin=atob(data.split(',')[1]); const arr=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); res(new Blob([arr],{type:mime})); } })}
  async function imageToWebPBlob(dataURL){ const img=await dataURLtoImage(dataURL); let {width:w,height:h}=img; const s=Math.min(1, MAX_IMG_EDGE/Math.max(w,h)); if(s<1){ w=Math.round(w*s); h=Math.round(h*s); } const c=document.createElement('canvas'); c.width=w; c.height=h; const cx=c.getContext('2d'); cx.drawImage(img,0,0,w,h); let blob=await canvasToBlob(c,'image/webp',WEBP_QUALITY); if(!blob||blob.size===0) blob=await canvasToBlob(c,'image/jpeg',0.85); return blob; }
  function parseHTML(html){ const d=document.createElement('div'); d.innerHTML=html; return d; }
  async function processNoteHTML(html,zipImages,seen){ const root=parseHTML(html); const imgs=[...root.querySelectorAll('img')]; for(const img of imgs){ const src=img.getAttribute('src')||''; if(!src.startsWith('data:image/')) continue; const blob=await imageToWebPBlob(src); const arr=await blob.arrayBuffer(); const hash=await crypto.subtle.digest('SHA-1',arr).then(h=>Array.from(new Uint8Array(h)).map(x=>x.toString(16).padStart(2,'0')).join('')); const ext='webp'; const filename=`images/${hash}.${ext}`; if(!seen.has(hash)){ seen.add(hash); zipImages.file(`${hash}.${ext}`, new Uint8Array(arr)); } img.setAttribute('src',filename); img.removeAttribute('width'); img.removeAttribute('height'); } return root.innerHTML; }
})();

// Fallback för skalstreck om funktionen saknas i din miljö
function updateScaleBar(){ try{ const sb=document.getElementById('sbBar'); const lbl=document.getElementById('sbLabel'); if(!sb||!lbl) return; const px=sb.clientWidth||120; const metersPerPixel=(250000/1073.6); const km=(px*metersPerPixel/1000).toFixed(1); lbl.textContent=`${km} km`; }catch(_){} }
</script>
</body>
</html>
